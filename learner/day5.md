# JPA Part 2

## ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸
![](https://velog.velcdn.com/images/duckbill/post/8403b438-0338-4a4a-bd35-f26e18b1d2bc/image.webp)

- ë¹„ì˜ì† : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ê´€ê³„ê°€ ì—†ëŠ” ìƒˆë¡œìš´ ìƒíƒœ (DBì— ì €ì¥ë˜ì§€ ì•ŠëŠ” ìƒíƒœ)
    - Entityë¥¼ ê´€ë¦¬í•˜ê³  ìˆëŠ” ìƒíƒœ Duty check, ì¡°íšŒ ì“°ê¸° ì§€ì—° ë“±ì„ ì§€ì›
- ì˜ì†(Managed) : ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ê³  ìˆëŠ” ìƒíƒœ
- ì¤€ì˜ì†(Detached) : ì˜ì†ì„± ì»¨í…ìŠ¤í‹ì—ì„œ ê´€ë¦¬ë˜ë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ
- ì‚­ì œ(Removed) : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚­ì œëœ ìƒíƒœ

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì´ì 
- 1ì°¨ ìºì‹œ ğŸ‘€ğŸ‘€  
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” 1ì°¨ ìºì‹œê°€ ì¡´ì¬í•œë‹¤. ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ëŠ” ìˆœê°„ 1ì°¨ ìºì‹œì— ê°ì²´ê°€ key, value ê°’ìœ¼ë¡œ ì €ì¥ëœë‹¤.  
  - ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ì¡°íšŒë¥¼ í•  ë•Œ ë¨¼ì € ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìˆëŠ” 1ì°¨ ìºì‹œì—ì„œ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì°¾ê³  ì—”í‹°í‹°ê°€ ì¡´ì¬í•  ê²½ìš° DBì— ì ‘ê·¼ í•˜ì§€ ì•Šê³  ë°˜í™˜í•œë‹¤.
      > ```java
      > @Test
      > void findCache() {
      > // FEAT: Entity Cache ì— ì˜í•˜ì—¬ í•œ ë²ˆë§Œ select ë¬¸ì´ ì‹¤í–‰ëœë‹¤. 1ì°¨ ìºì‹œë¥¼ í™œìš©í•´ ì„±ëŠ¥ì´ ìƒìŠ¹í•œë‹¤.
      >   System.out.println(memberRepository.findById(1L).get());
      >   System.out.println(memberRepository.findById(1L).get());
      >   System.out.println(memberRepository.findById(1L).get());
      > }
      > ```
      > - Entity Cacheì— ì˜í•˜ì—¬ findByIdì˜ ì¿¼ë¦¬ëŠ” í•œë²ˆë§Œ ìˆ˜í–‰ë˜ê²Œ ëœë‹¤.
      > - ì¿¼ë¦¬ ìˆ˜í–‰ì„ ì¤„ì„ìœ¼ë¡œì¨ ì„±ëŠ¥ì„ í–¥ìƒ ì‹œí‚¬ ìˆ˜ ìˆë‹¤.
      > - ë‹¨, í‚¤ ê°’ì´ ì•„ë‹Œ ê°’ì— ëŒ€í•˜ì—¬ ì¡°íšŒì‹œ entity cacheë¥¼ ìœ íš¨í•˜ê²Œ ì–»ê¸° ì–´ë µë‹¤.

- ë™ì¼ì„± ë³´ì¥  
  - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ êº¼ë‚´ì˜¨ ê°ì²´ëŠ” ë™ì¼ì„±ì´ ë³´ì¥ëœë‹¤.  
  - 1ì°¨ ìºì‹œë¡œ ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸° ë“±ê¸‰ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì°¨ì›ì—ì„œ ì œê³µí•œë‹¤.

- ì“°ê¸° ì§€ì—°  ğŸ‘ğŸ‘  
  - íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ persist()ê°€ ì¼ì–´ë‚ ë•Œ, ì—”í‹°í‹°ë¥¼ 1ì°¨ ìºì‹œì— ì €ì¥í•˜ê³ , ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œë¼ëŠ” ê³³ì— INSERT QUERYë¥¼ ìƒì„±í•´ì„œ ìŒ“ì•„ ë†“ëŠ”ë‹¤. ì´í›„ commit(), flush() ë¥¼ í•  ë•Œ ì“°ê¸°ì§€ì—°ëœ SQL QUERYë¥¼ DBì— ë³´ë‚¸ë‹¤.

- ë³€ê²½ ê°ì§€ ğŸ‘ğŸ‘ğŸ‘  
  - JPAì—ì„œëŠ” ì—”í‹°í‹°ë¥¼ ì—…ë°ì´íŠ¸ í• ë•Œ update(), persist() ì™€ ê°™ì€ ë©”ì†Œë“œë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì•Œë ¤ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤. ì´ê²ƒì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” ë³€ê²½ê°ì§€(Dirty Checking) ë•ë¶„ì´ë‹¤.

- í”ŒëŸ¬ì‹œ ğŸ‘ğŸ‘  
  - í”ŒëŸ¬ì‹œëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•œë‹¤.
  - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì—ì„œ í”ŒëŸ¬ì‹œê°€ ë°œìƒí•˜ëŠ”ë° ì´ë•Œ ì“°ê¸° ì§€ì—° ì €ì¥ì†Œì— ìŒ“ì—¬ ìˆëŠ” SQLë¬¸ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡í•œë‹¤.
  - ì˜ì†ì„± ìºì‹œê°€ `flush`ë˜ëŠ” ì‹œì 
    > 1. `flush` ë©”ì†Œë“œë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•œ ì‹œì 
    > 2. íŠ¸ëœì­ì…˜ì´ ëë‚˜ê³  `commit`ë˜ëŠ” ì‹œì 
    > 3. ë³µì¡í•œ ì¡°íšŒì˜ ì¡°ê±´ì—ì„œ JPA ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ì‹œì  (JPQL)

## ì˜ì†ì„± ì „ì´ (Cascade)
ì˜ì†ì„± ì „ì´ë¥¼ í†µí•´ í•˜ë‚˜ì˜ Entityê°€ ìƒì„±, ì—…ë°ì´íŠ¸ ë  ë–„ `í•˜ìœ„ Entity`ë„ ê°™ì´ `ìƒì„±`, `ì—…ë°ì´íŠ¸` í•´ì£¼ëŠ” ë°©ë²•

- PERSIST, REMOVE
    - ìƒìœ„ ì—”í‹°í‹°ê°€ ì˜ì† ì²˜ë¦¬ë  ë•Œ í•˜ìœ„ ì—”í‹°í‹°ë“¤ë„ ê°™ì´ ì˜ì† ì²˜ë¦¬
- MERGE, REFRESH, DETACH
    - ìƒìœ„ ì—”í‹°í‹°ì˜ ìƒíƒœê°€ ë³€ê²½ë  ë•Œ í•˜ìœ„ ì—”í‹°í‹°ë“¤ë„ ê°™ì´ ìƒíƒœ ë³€ê²½
- All
    - ìƒìœ„ ì—”í‹°í‹°ì˜ ëª¨ë“  ìƒíƒœ ë³€ê²½ì´ í•˜ìœ„ ì—”í‹°í‹°ì— ì ìš©

### In Spring ğŸ‘ğŸ‘ğŸ‘ğŸ‘
- **CascadeType.ALL: ëª¨ë“  Cascadeë¥¼ ì ìš©**
- **CascadeType.PERSIST: ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•  ë•Œ, ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ìœ ì§€**
- **CascadeType.MERGE: ì—”í‹°í‹° ìƒíƒœë¥¼ ë³‘í•©(Merge)í•  ë•Œ, ì—°ê´€ëœ ì—”í‹°í‹°ë„ ëª¨ë‘ ë³‘í•©**
- **CascadeType.REMOVE: ì—”í‹°í‹°ë¥¼ ì œê±°í•  ë•Œ, ì—°ê´€ëœ ì—”í‹°í‹°ë„ ëª¨ë‘ ì œê±°**
- **CascadeType.DETACH: ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ detach() ìˆ˜í–‰í•˜ë©´, ì—°ê´€ ì—”í‹°í‹°ë„ detach()ìƒíƒœê°€ ë˜ì–´ ë³€ê²½ ì‚¬í•­ ë°˜ì˜ X**
- **CascadeType.REFRESH: ìƒìœ„ ì—”í‹°í‹°ë¥¼ ìƒˆë¡œê³ ì¹¨(Refresh)í•  ë•Œ, ì—°ê´€ëœ ì—”í‹°í‹°ë„ ëª¨ë‘ ìƒˆë¡œê³ ì¹¨**

## Orphan Removal (ê³ ì•„ ì œê±°)
ì—°ê´€ ê´€ê³„ê°€ ì—†ì–´ì§„ `Entity`ë¥¼ ì œê±°

### Cascade REMOVE vs Orphan Removal
- Cascade remove
    - setOrders(null)ë¥¼ í˜¸ì¶œí•˜ë©´ ê´€ë ¨ Order ì—”í‹°í‹°ê°€ DBì—ì„œ ìë™ìœ¼ë¡œ ì œê±°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- Orphan Removal
  - setOrders(null)ë¥¼ í˜¸ì¶œí•˜ë©´ ê´€ë ¨ Order ì—”í‹°í‹°ê°€ DBì—ì„œ ìë™ìœ¼ë¡œ ì œê±° ë©ë‹ˆë‹¤.

## ë°ì´í„° ë¡œë”© (LAZY, EAGER)
### EAGER
> @OneToMany(fetch = FetchType.EAGER)

ë¶€ëª¨ ì—”í„°í‹°ì„ ë¡œë”©í•˜ë©´ ìì‹ ì—”í„°í‹°ë„ ê°™ì´ ë¡œë”©

### LAZY
> @OneToMany(fetch = FetchType.LAZY)

- ë¶€ëª¨ ì—”í„°í‹°ì„ ë¡œë”©í•˜ì—¬ë„ ìì‹ ì—”í„°í‹°ëŠ” ë¡œë”©ë˜ì§€ ì•ŠìŒ  
- LAZY Fetch íƒ€ì…ì€ ì‹¤ì œ ì—”í‹°í‹° ì¡°íšŒì‹œì— ë°”ë¡œ ê°€ì§€ê³  ì˜¤ì§€ ì•Šê³ , ì—°ê´€ ê´€ê³„ì— ìˆëŠ” ì—”í‹°í‹°ë¥¼ ì°¸ì¡°í• ë•Œ ê°€ì ¸ì˜¤ê²Œ ëœë‹¤.  
- í•˜ì§€ë§Œ, ë™ì¼í•œ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì£¼ì¸ ê°ì²´ë¥¼ ë¡œë”©í•˜ëŠ” ë°©ë²• ì¡´ì¬

---

## Software Delete

ì‹¤ì œ ìš´ìš©í™˜ê²½ì—ì„œ delete ë°©ì‹ì€ ìœ„í—˜ì„±ì´ ìˆìœ¼ë¯€ë¡œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°©ì‹ì€ ì•„ë‹ˆë‹¤. ë”°ë¼ì„œ, ì†Œí”„íŠ¸ì›¨ì–´ì ìœ¼ë¡œ delete ë˜ì—ˆë‹¤ë¡œë§Œ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.

ë”°ë¼ì„œ, DBì—ì„œëŠ” ê°’ì´ ì¡´ì¬í•˜ì§€ë§Œ Logic ìƒì—ì„œëŠ” ê°’ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤.

- ì˜ˆì œ

```java
@Entity
@Where(clause = "deleted = false")
public class Book {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String category;
    private Long authorId;
    @ToString.Exclude
    private boolean deleted; // true : deleted, false : not deleted
}
```

1. Book entityì— ëŒ€í•˜ì—¬ deleted flagë¥¼ ìƒì„±í•œë‹¤.
2. Book entityì— `@Where` Annotationì„ ë¶™ì´ê³  deleted=false ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ JPA ì¿¼ë¦¬ë¬¸ì— í•­ìƒ `where deleted = false` ë¬¸ì´ ë¶™ê²Œ ëœë‹¤.